# Initialise mise
[Console]::WriteLine("Initialising mise-en-place...")
(&mise activate pwsh) | Out-String | Invoke-Expression

# Initialize Starship
[Console]::WriteLine("Initializing Starship...")
if (Get-Command starship -ErrorAction SilentlyContinue) {
    Invoke-Expression (&starship init powershell)
} else {
    Write-Host "Installing Starship..."
    mise install starship
    # Refresh PATH
    $env:PATH = [System.Environment]::GetEnvironmentVariable("PATH","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PATH","User")
    if (Get-Command starship -ErrorAction SilentlyContinue) {
        Invoke-Expression (&starship init powershell)
    }
}

[Console]::WriteLine("Setting up PowerShell...")
Set-PSReadLineOption -BellStyle None


# Install PSFzf for fuzzy finding
if (-not(Get-Module -ListAvailable -Name PSFzf)) {
    Write-Host "Installing PSFzf module..."
    Install-Module -Name PSFzf -Scope CurrentUser -Force -AllowClobber
}
Import-Module PSFzf

# Set up PSFzf key bindings
Set-PsFzfOption -PSReadlineChordProvider 'Ctrl+f' -PSReadlineChordReverseHistory 'Ctrl+r'

# Enhanced completion styling
$PSReadLineOptions = @{
    Colors = @{
        Command = 'Green'
        Parameter = 'Gray'
        Operator = 'Magenta'
        Variable = 'Yellow'
        String = 'Blue'
        Number = 'DarkCyan'
        Type = 'Cyan'
        Comment = 'DarkGreen'
    }
}

# Add Bun to PATH if it exists
$BunPath = "$env:USERPROFILE\.bun\bin"
if (Test-Path $BunPath) {
    if ($env:PATH -notlike "*$BunPath*") {
        $env:PATH = "$BunPath;$env:PATH"
    }
}

# Define functions
function quit
{ exit
}


function set-link ($target, $link)
{
  New-Item -Path $link -ItemType SymbolicLink -Value $target
}

# Check if Windows
if ($IsWindows)
{
{{ if (not ( .work )) }}
if (-not(Test-Path -path @(($ENV:UserProfile + "\.config\winget-installed-needed")))) {
  # Checking installed packages
  [Console]::WriteLine("Checking installed packages...")
  $packages = @(
    "twpayne.chezmoi",
    "StartIsBack.StartAllBack",
    "Git.Git",
    "HermannSchinagl.LinkShellExtension",
    "Microsoft.DotNet.Runtime.8",
    "Microsoft.DotNet.AspNetCore.8",
    "Microsoft.DotNet.DesktopRuntime.8",
    "Microsoft.DotNet.SDK.8",
    "Microsoft.NuGet",
    "Kitware.CMake"
  )
  $packages | ForEach-Object {
    winget list -q $_ | Out-Null
    if ($?)
    {
      # [Console]::WriteLine("$_ installed")
    } else
    {
     [Console]::WriteLine( "Package $_ not found. Installing...")
      winget install $_
    }
  }
  [Console]::WriteLine("All packages installed. To retrigger this check, run `resetwingetstatus`.")
  New-Item -Path @(($ENV:UserProfile + "\.config\winget-installed-needed"))
}
{{ end }}
function dwingetinstalledneeded {
  Remove-Item -Path @(($ENV:UserProfile + "\.config\winget-installed-needed"))
  }
  new-alias resetwingetstatus dwingetinstalledneeded
  # Create symbolic links
  [Console]::WriteLine("Creating symbolic links...")
  $symlinks = @(
@(($ENV:UserProfile + "\.config\helix"), ($ENV:Appdata + "\helix")),
    @(($ENV:UserProfile + "\.config\nvim"), ($ENV:LocalAppdata + "\nvim")),
    @(($ENV:UserProfile + "\.config\alacritty"), ($ENV:Appdata + "\Alacritty")),
    @(($ENV:UserProfile + "\.config\zed"), ($ENV:Appdata + "\Zed"))
      )
  foreach ($link in $symlinks)
  {
    if (Test-Path -Path $link[1])
    {
    } else
    {
      set-link $link[0] $link[1]     }
  }
}
[Console]::WriteLine( "Defining aliases...")
function wslzellij { wsl SHELL="pwsh.exe" zellij }
New-Alias zellij wslzellij -Option AllScope -Force
New-Alias cls clear -Option AllScope -Force
New-Alias c clear -Option AllScope -Force
New-Alias q quit -Option AllScope -Force
New-Alias qa quit -Option AllScope -Force
function hyfet { py -m hyfetch --config-file="$env:USERPROFILE\.config\hyfetch.json" ${args} }
{{ if .work }}
New-Alias hyfetch fastfetch -Option AllScope -Force
{{ else }}
New-Alias hyfetch hyfet -Option AllScope -Force
{{ end }}
New-Alias cat bat -Option AllScope -Force
function els { eza --icons ${args} }
New-Alias ls els -Option AllScope -Force
function ela { eza -l --icons ${args} }
New-Alias la ela -Option AllScope -Force
function ell { eza -al --icon ${args} }
New-Alias ll ell -Option AllScope -Force
function elt { eza -a --tree --level=1 --icons ${args} }
New-Alias lt elt -Option AllScope -Force
function shutdownnow { shutdown /s /t 0 }
New-Alias shutdown shutdownnow -Option AllScope -Force
function rebootnow { shutdown /r /t 0 }
New-Alias reboot rebootnow -Option AllScope -Force
function cargocleanall { cargo-clean-all --keep-days 21 ~ -i ${args} }
New-Alias cargock cargocleanall -Option AllScope -Force


# Zoxide
[Console]::WriteLine( "Loading Zoxide...")
Invoke-Expression (& { (zoxide init powershell --cmd bang | Out-String) })
function zap {
  $isGit = Test-Path -Path "./.git"
  $isJJ = Test-Path -Path "./.jj"

  if ($isGit -and $isJJ) {
    Clear-Host
    Write-Host "Opened Git-colocated Jujutsu repository: $pwd"
    git fetch
    kc
    jj status
    eza --icons -L 2 -R --tree --git-ignore
  }
  elseif ($isJJ) {
    Clear-Host
    Write-Host "Opened Jujutsu repository: $pwd"
    jj status
    eza --icons -L 2 -R --tree
  }
  elseif ($isGit) {
    Clear-Host
    Write-Host "Opened Git repository: $pwd"
    git fetch
    kc
    git status
    eza --icons -L 2 -R --tree --git-ignore
  }
  else {
    eza -a --icons
    }
}

function banger() {
if($args.Count -eq 0) {
    bang
} else {
  bang $args[0]
  }
  zap
}
function bangeri() {
if($args.Count -eq 0) {
    bangi
} else {
  bangi $args[0]
  }
  zap
}
New-Alias cd banger -Option AllScope -Force
New-Alias cdi bangeri -Option AllScope -Force
